<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="../assets/js/jquery.js"></script>
    <script src='./jspsych.js'></script>
    <script src='../assets/jspsych/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='../assets/jspsych/plugins/jspsych-survey-text.js'></script>
    <script src="../assets/jspsych/plugins/jspsych-call-function.js"></script>
    <script src='../assets/jspsych/plugins/jspsych-preload.js'></script>
    <script src='../assets/jspsych/plugins/jspsych-html-button-response.js'></script>
    <script src="../assets/jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="../assets/jspsych/plugins/jspsych-survey-html-form.js"></script>
    <script src="../assets/jspsych/plugins/jspsych-instructions.js"></script>
    <script src="../assets/jspsych/plugins/jspsych-fullscreen.js"></script>
    <link href="./jspsych.css" rel="stylesheet" type="text/css">
    <script src="../assets/psychophysics/jspsych-psychophysics.js"></script>
    <script src="../assets/js/jSignature/jSignature.min.js"></script>

    <head>
        <style>
          body {
            background-color: rgb(128, 128, 128);  /*背景灰色*/
            color: white;
          }
        </style>
      </head>
    
    </head>
    
    <body></body>
    <script>

var timeline = [] //设置一个时间线

var fullscreen_trial = {
    type: 'fullscreen',
    fullscreen_mode: true,
    message: "<p style = 'color : white'>实验需要全屏模式，实验期间请勿退出全屏。</p >",
    button_label: "点击这里进入全屏"
  }
  timeline.push(fullscreen_trial);//将全屏设置放入到时间线里


  function permutation(arr, num) { //定义排列组合的function
    var r = [];
    (function f(t, a, n) {
      if (n == 0) return r.push(t);
      for (var i = 0, l = a.length; i < l; i++) {
        f(t.concat(a[i]), a.slice(0, i).concat(a.slice(i + 1)), n - 1);
      }
    })([], arr, num);
    return r;
  }


const images = ['img/C_ambi40.png', 
'img/S_ambi40.png', 
'img/T_ambi40.png']

const preload = {
    type: 'preload',
    images: images,
  }
timeline.push(preload);//preload图片

var words = ["圆形", "方形", "三角"]//储存文字

var key = ['f', 'j']//按键
//正确率70%
let acc = 70;
let view_texts_images = [];

var welcome = {
    type: "html-keyboard-response",
    stimulus: `
     <p>您好，欢迎参加本次实验。</p>
     <p>为充分保障您的权利，请确保你已经知晓并同意《参与实验同意书》以及《数据公开知情同意书》。</p>
     <p>如果你未见过上述内容，请咨询实验员。</p>
     <p>如果您选择继续实验，则表示您已经清楚两份知情同意书的内容并同意。</p>
     <p> <div style = "color: green"><按任意键至下页></div> </p>
     `,
    choices: jsPsych.ALL_KEYS,
  };
  timeline.push(welcome);

  var basic_information = {
    type: "html-keyboard-response",
    stimulus: `
     <p>本实验首先需要您填写一些基本个人信息。</p>
     <p> <div style = "color: green"><按任意键至下页></div></p>
     `,
    choices: jsPsych.ALL_KEYS,
  };
  timeline.push(basic_information);

  var info = []

  /* basic data collection instructions trial 被试基本信息收集 */
  var information = [{
    // 实验被试信息收集
    type: "call-function", //探测被试显示器数据
    func: function () {
      if ($(window).outerHeight() < 500) {
        alert("你设备不支持实验，请进入全屏模式。若已进入全屏，请换一台高分辨率的设备，谢谢。");
        window.location = "";
      }
    }
  }, {
    type: "survey-html-form",
    preamble: "<p style =' color : white'>你的实验编号是</p>",
    html: function () {
      let data = localStorage.getItem(info["subj_idx"]) ? JSON.parse(localStorage.getItem(info["subj_idx"]))["Name"] : "";
      return "<p><input name='Q0' type='text' value='" + data + "' required/></p>";
    },
    button_label: "继续",
    on_finish: function (data) {
      info["ID"] = data.response.Q0;
      key = permutation(key, 2)[parseInt(info["ID"]) % 2] //对应的按键
      view_texts_images = [] //指导语中呈现的图片和文字对应关系
      jsPsych.randomization.shuffle(images).forEach((v, i) => { //将image随机
        view_texts_images.push(`<img src="${v}" width=150 style="vertical-align:middle">---${words[images.indexOf(v)]}`); //image编号和文字对应
      })

    }
  }, {
    type: "html-button-response",
    stimulus: "<p style = 'color : white'>你的性别</p>",
    choices: ['男', '女', '其他'],
    on_finish: function (data) {
      info["Sex"] = data.response == 0 ? "Male" : (data.response == 1 ? "Female" : "Other")
    }
  }, {
    type: "survey-html-form",
    preamble: "<p style = 'color : white'>你的出生年</p>",
    html: function () {
      let data = localStorage.getItem(info["subj_idx"]) ? JSON.parse(localStorage.getItem(info["subj_idx"]))["BirthYear"] : "";
      return `<p>
        <input name="Q0" type="number" value=${data} placeholder="1900~2023" min=1900 max=2023 oninput="if(value.length>4) value=value.slice(0,4)" required />
        </p>`
    },
    button_label: '继续',
    on_finish: function (data) {
      info["BirthYear"] = data.response.Q0;
    }
  }, {
    type: "survey-html-form",
    preamble: "<p style = 'color : white'>您的教育经历是</p>",
    html: function () {
      return `
                <p><select name="Q0" size=10>
                <option value=1>小学以下</option>
                <option value=2>小学</option>
                <option value=3>初中</option>
                <option value=4>高中</option>
                <option value=5>大学</option>
                <option value=6>硕士</option>
                <option value=7>博士</option>
                <option value=8>其他</option>
                </select></p>`
    },
    on_load: function () {
      $("option[value=" + (["below primary school", "primary school", "junior middle school", "high school", "university", "master", "doctor", "other"].indexOf(localStorage.getItem(info["subj_idx"]) ? JSON.parse(localStorage.getItem(info["subj_idx"]))["Education"] : "") + 1) + "]").attr("selected", true);
    },
    button_label: '继续',
    on_finish: function (data) {
      let edu = ["below primary school", "primary school", "junior middle school", "high school", "university", "master", "doctor", "other"];

      info["Education"] = edu[parseInt(data.response.Q0) - 1];
    }
  }];
  timeline.push({
    timeline: information,
  });

//设置根据屏幕控制显示图形大小方位一致
let scale = Math.min($(document).width() / 1440, $(document).height() / 900);
  $(window).resize(function () {
    scale = Math.min($(document).width() / 1440, $(document).height() / 900);
  });


  var instructions = {
    type: "instructions",
    pages: function () {
      let start = "<p class='header'>请您记住如下对应关系:</p>",
        middle = "<p class='footer'>如果对本实验还有不清楚之处，请立即向实验员咨询。</p>",
        end = "<p>如果你明白了规则：</p><p>请按 继续 进入刺激呈现顺序为<span style='color: yellow;'>先图形后文字条件</span>的练习</p><div>";
      let tmpI = "";
      view_texts_images.forEach(v => {
        tmpI += `<p class="content">${v}</p>`;
      });
      return ["<p class='header'>实验说明：</p><p>您好，欢迎参加本实验。本次实验大约需要30分钟完成。</p><p>在本实验中，您需要完成一个简单的知觉匹配任务。</p><p>您将学习几种几何图形与不同标签的对应关系。</p>",
        start + `<div class="box">${tmpI}</div>` +
        `<p class='footer'>您的任务是在不同图形和文字呈现顺序的条件下判断几何图形与图形名称或文字标签是否匹配，</p><p class='footer'>如果二者匹配，请按 <span style="color: lightgreen;">${key[0]} 键</span></p><p class='footer'>如果二者不匹配，请按<span style="color: lightgreen;"> ${key[1]} 键</p></span><p class='footer'>请在实验过程中将您的<span style="color: lightgreen;">食指</span>放在电脑键盘的相应键位上进行按键。</p></span>`,
        `<p>您将首先完成三组不同的刺激呈现顺序：<span style="color: yellow;">先图形后文字、先文字后图形以及图形和文字同时呈现</span>条件下，每组72次按键的匹配任务练习。</p><p>完成匹配任务的练习之后，您将完成每个条件下4组匹配任务，每组包括72次按键反应，每组完成后会有休息时间。</p><p>完成一组任务大约需要3分钟，整个实验将持续大约30分钟。</p>`,//实验时间待修改
        middle + end];
    },
    show_clickable_nav: true,
    show_page_number: true,
    button_label_previous: '返回',
    button_label_next: '继续',
    on_load: () => {
      $("body").css("cursor", "default");
    },
    on_finish: function () {
      $("body").css("cursor", "none");
    } //鼠标消失术，放在要消失鼠标的前一个事件里
  }
  timeline.push(instructions);






  let prac_i = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale,
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1000// ms after the start of the trial
        }, 
        {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1050,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
            origin_center: true//待确定
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: "center", //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable('word', true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°

            text_color: 'white',
            show_start_time: 1150, // ms after the start of the trial
            show_end_time: 1200,//出现50ms
            origin_center: true//带确定
          }
        ],

    choices: ['f', 'j'],
    response_start_time:1150,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"prac_image_first"//储存condition，在这里为image_first，先出现图片
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,//正是实验时改为6
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 }


 var feedback_p = {
    type: "html-keyboard-response",
    stimulus: function () {
      let trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72); // 运行逻辑：先挑出data里的所有的correct：true/false的数据行，成为新的数组，然后对倒数的某几组进行计算
      //这里填入timeline_variables里面的trial数量
      let correct_trials = trials.filter({
        correct: true
      });
      let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      let rt = Math.round(correct_trials.select('rt').mean());
      return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
        "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>";
    }
  }



var feedback_continue_practice1 = { //在这里呈现文字recap，让被试再记一下
    type: "instructions",
    pages: function () {
      let start = "<p class='header'>请您努力记下如下匹配对应关系，再次进行练习。</p>",
        middle = "<p class='footer'>如果对本实验还有不清楚之处，请立即向实验员咨询。</p>",
        end = "<p>如果你明白了规则：</p><p>请按 继续 进入练习</p><div>";
      let tmpI = "";
      view_texts_images.forEach(v => {
        tmpI += `<p class="content">${v}</p>`;
      });
      return ["<p class='header'>您的正确率未达到进入下一阶段练习的要求。</p>",
        start + `<div class="box">${tmpI}</div>` +
        `<p class='footer'>您的任务是判断几何图形与图形名称或文字标签是否匹配，</p><p class='footer'>如果二者匹配，请按 <span style="color: lightgreen;">${key[0]} 键</span></p><p class='footer'>如果二者不匹配，请按<span style="color: lightgreen;"> ${key[1]} 键</p></span><p class='footer'>请在实验过程中将您的<span style="color: lightgreen;">食指</span>放在电脑键盘的相应键位上进行按键。</p></span>`,
        middle + end];
    },
    show_clickable_nav: true,
    show_page_number: true,
    button_label_previous: '返回',
    button_label_next: '继续',
    on_finish: function () {
      $("body").css("cursor", "none");
    },
    on_load: () => {
      $("body").css("cursor", "default");
    }
  }


var if_node1 = { //if_node 用于判断是否呈现feedback，feedback_continue_practice
    timeline: [feedback_p, feedback_continue_practice1],
    conditional_function: function (data) {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//这里注意：只需要上一组的练习数据，而不是所有的数据！！ 如何实现：.last() 取data最后的几组数据（上一组练习数据）
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//达标就skip掉feedback_continue_practice这一段
      } else if (accuracy < acc) { //没达标反馈feedback,feedback_continue_practice
        return true;
      }
    }
  }



  var loop_node1 = {
    timeline: [prac_i, if_node1],
    loop_function: function () {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//记得改，取数据
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//end 进入正式实验前的反馈
      } else if (accuracy < acc) { // repeat
        return true;
      }
    }
  }
  timeline.push(loop_node1);


var prac_w = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale,//pixels 视角：0.8° x 0.8°
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1000// ms after the start of the trial
        }, 
        {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1150, // ms after the start of the trial
            show_end_time: 1200,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: "center", //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable('word', true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°, //字体和颜色设置 文字视角：3.6° x 1.6°

            text_color: 'white',
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1050,//出现50ms
            origin_center: true
          }
        ],

        choices: ['f', 'j'],
    response_start_time:1150,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"prac_word_first"//储存condition，在这里为word_first，先出现文字
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 }

  var feedback_gow = {
    type: "html-keyboard-response",
    stimulus: function () {
      let trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);
      let correct_trials = trials.filter({
        correct: true
      });
      let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      let rt = Math.round(correct_trials.select('rt').mean());
      return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
        "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>" +
        "<p class='context'>恭喜你完成这一阶段的练习。按任意键进入<span style='color: yellow;'>先文字后图形条件</span>的练习。</p></div>";
    },
    on_finish: function () {
      $("body").css("cursor", "none");
    }
  }
  timeline.push(feedback_gow);

var feedback_continue_practice2 = { //在这里呈现文字recap，让被试再记一下
    type: "instructions",
    pages: function () {
      // let tmpT = [
      //   '<p>您的正确率未达到练习要求。</p>',
      //   '<p>请您努力记下如下匹配对应关系，再次进行练习。</p>'
      // ]
      // view_texts_images.forEach(v => {
      //   tmpT.push(v)
      // })
      // tmpT.push(
      //   `<p>您的任务是判断几何图形与图形名称或文字标签是否匹配：</p><p>当出现的图形与下方的名称一致时请按<strong>“${key[0]}”</strong>键，否则按<strong>“${key[1]}”</strong>键。</p><p>请您在实验过程中，将两个手指放到相应的键盘位上</p>`,
      //   '<p> 如果你明白了规则，请按任意键继续练习。</p>'
      // )
      let start = "<p class='header'>请您努力记下如下匹配对应关系，再次进行练习。</p>",
        middle = "<p class='footer'>如果对本实验还有不清楚之处，请立即向实验员咨询。</p>",
        end = "<p>如果你明白了规则：</p><p>请按 继续 进入练习</p><div>";
      let tmpI = "";
      view_texts_images.forEach(v => {
        tmpI += `<p class="content">${v}</p>`;
      });
      return ["<p class='header'>您的正确率未达到进入下一阶段练习的要求。</p>",
        start + `<div class="box">${tmpI}</div>` +
        `<p class='footer'>您的任务是判断几何图形与图形名称或文字标签是否匹配，</p><p class='footer'>如果二者匹配，请按 <span style="color: lightgreen;">${key[0]} 键</span></p><p class='footer'>如果二者不匹配，请按<span style="color: lightgreen;"> ${key[1]} 键</p></span><p class='footer'>请在实验过程中将您的<span style="color: lightgreen;">食指</span>放在电脑键盘的相应键位上进行按键。</p></span>`,
        middle + end];
    },
    show_clickable_nav: true,
    show_page_number: true,
    button_label_previous: '返回',
    button_label_next: '继续',
    on_finish: function () {
      $("body").css("cursor", "none");
    },
    on_load: () => {
      $("body").css("cursor", "default");
    },
  }


  var if_node2 = { //if_node 用于判断是否呈现feedback，feedback_continue_practice
    timeline: [feedback_p, feedback_continue_practice2],
    conditional_function: function (data) {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//这里注意：只需要上一组的练习数据，而不是所有的数据！！ 如何实现：.last() 取data最后的几组数据（上一组练习数据）
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//达标就skip掉feedback_continue_practice这一段
      } else if (accuracy < acc) { //没达标反馈feedback,feedback_continue_practice
        return true;
      }
    }
  }


  var loop_node2 = {
    timeline: [prac_w, if_node2],
    loop_function: function () {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//记得改，取数据
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//end 进入正式实验前的反馈
      } else if (accuracy < acc) { // repeat
        return true;
      }
    }
  }
  timeline.push(loop_node2);



  var prac_s = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale, // pixels 视角：0.8° x 0.8°
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1100// ms after the start of the trial
        }, 
       {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: -165.29 * scale, //图形和文字距离 与加号等距
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1100,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
            origin_center: true
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: 165.29 * scale, //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable("word", true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°
            text_color: 'white',
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1100,//出现50ms
            origin_center: true
          }
        ],

        choices: ['f', 'j'],
    response_start_time:1100,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"prac_simultaneous"//储存condition，在这里为image_first，先出现图片
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,//正是实验时改为6
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 } 

  var feedback_gos = {
    type: "html-keyboard-response",
    stimulus: function () {
      let trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);
      let correct_trials = trials.filter({
        correct: true
      });
      let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      let rt = Math.round(correct_trials.select('rt').mean());
      return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
        "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>" +
        "<p class='context'>恭喜你完成练习。按任意键进入<span style='color: yellow;'>图形和文字同时呈现条件</span>的练习。</p></div>";
    },
    on_finish: function () {
      $("body").css("cursor", "none");
    }
  }
  timeline.push(feedback_gos);

var feedback_continue_practice3 = { //在这里呈现文字recap，让被试再记一下
    type: "instructions",
    pages: function () {
      // let tmpT = [
      //   '<p>您的正确率未达到练习要求。</p>',
      //   '<p>请您努力记下如下匹配对应关系，再次进行练习。</p>'
      // ]
      // view_texts_images.forEach(v => {
      //   tmpT.push(v)
      // })
      // tmpT.push(
      //   `<p>您的任务是判断几何图形与图形名称或文字标签是否匹配：</p><p>当出现的图形与下方的名称一致时请按<strong>“${key[0]}”</strong>键，否则按<strong>“${key[1]}”</strong>键。</p><p>请您在实验过程中，将两个手指放到相应的键盘位上</p>`,
      //   '<p> 如果你明白了规则，请按任意键继续练习。</p>'
      // )
      let start = "<p class='header'>请您努力记下如下匹配对应关系，再次进行练习。</p>",
        middle = "<p class='footer'>如果对本实验还有不清楚之处，请立即向实验员咨询。</p>",
        end = "<p>如果你明白了规则：</p><p>请按 继续 进入练习</p><div>";
      let tmpI = "";
      view_texts_images.forEach(v => {
        tmpI += `<p class="content">${v}</p>`;
      });
      return ["<p class='header'>您的正确率未达到进入正式实验的要求。</p>",
        start + `<div class="box">${tmpI}</div>` +
        `<p class='footer'>您的任务是判断几何图形与图形名称或文字标签是否匹配，</p><p class='footer'>如果二者匹配，请按 <span style="color: lightgreen;">${key[0]} 键</span></p><p class='footer'>如果二者不匹配，请按<span style="color: lightgreen;"> ${key[1]} 键</p></span><p class='footer'>请在实验过程中将您的<span style="color: lightgreen;">食指</span>放在电脑键盘的相应键位上进行按键。</p></span>`,
        middle + end];
    },
    show_clickable_nav: true,
    show_page_number: true,
    button_label_previous: '返回',
    button_label_next: '继续',
    on_load: () => {
      $("body").css("cursor", "default");
    },
    on_finish: function () {
      $("body").css("cursor", "none");
    }
  }


  var if_node3 = { //if_node 用于判断是否呈现feedback，feedback_continue_practice
    timeline: [feedback_p, feedback_continue_practice3],
    conditional_function: function (data) {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//这里注意：只需要上一组的练习数据，而不是所有的数据！！ 如何实现：.last() 取data最后的几组数据（上一组练习数据）
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//达标就skip掉feedback_continue_practice这一段
      } else if (accuracy < acc) { //没达标反馈feedback,feedback_continue_practice
        return true;
      }
    }
  }


  var loop_node3 = {
    timeline: [prac_s, if_node3],
    loop_function: function () {
      var trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);//记得改，取数据
      var correct_trials = trials.filter({
        correct: true
      });
      var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      if (accuracy >= acc) {
        return false;//end 进入正式实验前的反馈
      } else if (accuracy < acc) { // repeat
        return true;
      }
    }
  }
  timeline.push(loop_node3);






var feedback_goformal = {
    type: "html-keyboard-response",
    stimulus: function () {
      let trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);
      let correct_trials = trials.filter({
        correct: true
      });
      let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      let rt = Math.round(correct_trials.select('rt').mean());
      return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
        "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>" +
        "<p class='context'>恭喜你完成练习。按任意键进入正式实验。</p>" + 
        "<p class='context'>首先是<span style='color: yellow;'>先图形后文字呈现条件</span>的<span style='color: lightgreen;'>正式实验</span></p></div>"
    },
    on_finish: function () {
      $("body").css("cursor", "none");
    }
  }
  timeline.push(feedback_goformal);



let image_first = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale,
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1000// ms after the start of the trial
        }, 
        {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1050,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
            origin_center: true//待确定
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: "center", //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable('word', true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°

            text_color: 'white',
            show_start_time: 1150, // ms after the start of the trial
            show_end_time: 1200,//出现50ms
            origin_center: true//带确定
          }
        ],

        choices: ['f', 'j'],
    response_start_time:1150,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"image_first"//储存condition，在这里为image_first，先出现图片
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,//正是实验时改为6
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 }



let word_first = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale,//pixels 视角：0.8° x 0.8°
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1000// ms after the start of the trial
        }, 
        {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1150, // ms after the start of the trial
            show_end_time: 1200,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: "center", //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable('word', true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°, //字体和颜色设置 文字视角：3.6° x 1.6°

            text_color: 'white',
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1050,//出现50ms
            origin_center: true
          }
        ],

        choices: ['f', 'j'],
    response_start_time:1150,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"word_first"//储存condition，在这里为word_first，先出现文字
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,//正是实验时改为6
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 }



 let same = {
    timeline:[
    {
    type:"psychophysics", 
    stimuli:[
        {
            obj_type: 'cross',
            startX: "center", // location of the cross's center in the canvas
            startY: "center",
            line_length: 62.5 * scale, // pixels 视角：0.8° x 0.8°
            line_width: 5 * scale,
            line_color: 'white', // You can use the HTML color name instead of the HEX color.
            show_start_time: 500,
            show_end_time: 1100// ms after the start of the trial
        }, 
       {
            obj_type:"image",
            file: jsPsych.timelineVariable("Image"),
            startX: "center", // location of the cross's center in the canvas
            startY: -165.29 * scale, //图形和文字距离 与加号等距
            font: (50).toString() + "px 'Arial'",
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1100,//出现50ms
            scale: 0.6456640625 * scale, // 调整图片大小 视角：3.8° x 3.8°
            origin_center: true
        },//上一组end时间减去下一组show时间就是空屏的100ms
        {
            obj_type: 'text',
            file: jsPsych.timelineVariable("word"),
            startX: "center",
            startY: 165.29 * scale, //图形和文字距离 与加号等距
            content: function () {
              return jsPsych.timelineVariable("word", true);
            },
            font: `${69.58 * scale}px 'Arial'`, //字体和颜色设置 文字视角：3.6° x 1.6°
            text_color: 'white',
            show_start_time: 1000, // ms after the start of the trial
            show_end_time: 1100,//出现50ms
            origin_center: true
          }
        ],

        choices: ['f', 'j'],
    response_start_time:1100,//开始作答时间，第二个刺激开始计算
    trial_duration:2650,//结束时间，一共作答时间持续1500ms
    data:jsPsych.timelineVariable("identify"),
    on_finish: function(data){
        data.correct_response = jsPsych.timelineVariable("identify", true)();
        data.correct = data.correct_response == data.key_press//0错1对
    },
    data:{
        "Image":jsPsych.timelineVariable("Image"),//储存Image名称
        "word":jsPsych.timelineVariable("word"),//储存文字
        //"condition":jsPsych.timelineVariable("image_first")
    }, 
    data:{
        "condition":"simultaneous"//储存condition，在这里为image_first，先出现图片
    }
},
{
    data:{
        screen_id: "feedback_test"//这里为反馈
    },
    type:"html-keyboard-response",
    stimulus:function(){
        let keypress = jsPsych.data.get().last(1).values()[0].key_press; // 被试按键
          //let trial_keypress = jsPsych.data.get().last(1).values()[0].correct; //该trial正确的按键
          let time = jsPsych.data.get().last(1).values()[0].rt;
          let trial_correct_response = jsPsych.data.get().last(1).values()[0].correct_response;//该trial正确的按键
          if (time > 1500 || time === null) { //大于1500或为null为过慢
            return "<span class='add_' style='color:yellow; font-size: 30px;'> 太慢! </span>"
          } else if (time < 200) { //小于两百为过快反应
            return "<span style='color:yellow; font-size: 30px;'>过快! </span>"
          } else {
            if (keypress == trial_correct_response) { //如果按键 == 正确按键
              return "<span style='color:GreenYellow; font-size: 30px;'>正确! </span>"
            }
            else {
              return "<span style='color:red; font-size: 30px;'>错误! </span>"
            }
          }
    },

    choices:jsPsych.NO_KEYS,
    trial_duration:300,//300ms反馈
}
],

    timeline_variables:[
        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},

        {Image:images[0], word:words[1], identify:function(){return key[1]}},
        {Image:images[1], word:words[2], identify:function(){return key[1]}},
        {Image:images[2], word:words[0], identify:function(){return key[1]}},

        {Image:images[0], word:words[2], identify:function(){return key[1]}},
        {Image:images[1], word:words[0], identify:function(){return key[1]}},
        {Image:images[2], word:words[1], identify:function(){return key[1]}},

        {Image:images[0], word:words[0], identify:function(){return key[0]}},
        {Image:images[1], word:words[1], identify:function(){return key[0]}},
        {Image:images[2], word:words[2], identify:function(){return key[0]}},
    ],
    randomize_order:true,
    repetitions:6,//正是实验时改为6
    on_finish:function(){
        // $("body").css("cursor", "default"); //鼠标出现
    }
 }




///////block的反馈

let feedback_block = {
    type: "html-keyboard-response",
    stimulus: function () {
      // aaaaa = 1;  筛选，必须要！！！！！！！！！！！
      let trials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      ).last(72);// last()填入一个block里的trial总数
      let correct_trials = trials.filter({
        correct: true
      });
      let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
      let rt = Math.round(correct_trials.select('rt').mean());
      return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
        "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>" +
        "<p class='context'>请按任意键进入休息</p></div>";
    },
    on_finish: function () {
      // $("body").css("cursor", "default"); //鼠标出现
    }
  };

  let blockTotalNum_image = 3;// 此处填入总block数量-1，比如总数量是3，那么值就需要是2
  let rest_image = {
  type:"html-button-response",
  stimulus: function () {
      let totaltrials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      );
      return `
                    <p>你当前还剩余${blockTotalNum_image}组实验</p>
                    <p>现在是休息时间，当你结束休息后，你可以点击 结束休息 按钮 继续</p>
                    <p>建议休息时间还剩余<span id="iii">60</span>秒</p>`
    },
    choices: ["结束休息"],
    on_load: function () {
      $("body").css("cursor", "default");
      let tmpTime = setInterval(function () {
        $("#iii").text(parseInt($("#iii").text()) - 1);
        if (parseInt($("#iii").text()) < 1) {
          $("#iii").parent().text("当前限定休息时间已到达，如果还未到达状态，请继续休息");
          clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
        }
      }, 1000);
      sessionStorage.setItem("tmpInter", tmpTime);
    },
    on_finish: function () {
      $("body").css("cursor", "none"); //鼠标消失
      blockTotalNum_image -= 1;
      $(document.body).unbind();
      clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
    }
  }

let blockTotalNum_word = 3;// 此处填入总block数量-1，比如总数量是3，那么值就需要是2
let rest_word = {
  type:"html-button-response",
  stimulus: function () {
      let totaltrials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      );
      return `
                    <p>你当前还剩余${blockTotalNum_word}组实验</p>
                    <p>现在是休息时间，当你结束休息后，你可以点击 结束休息 按钮 继续</p>
                    <p>建议休息时间还剩余<span id="iii">60</span>秒</p>`
    },
    choices: ["结束休息"],
    on_load: function () {
      $("body").css("cursor", "default");
      let tmpTime = setInterval(function () {
        $("#iii").text(parseInt($("#iii").text()) - 1);
        if (parseInt($("#iii").text()) < 1) {
          $("#iii").parent().text("当前限定休息时间已到达，如果还未到达状态，请继续休息");
          clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
        }
      }, 1000);
      sessionStorage.setItem("tmpInter", tmpTime);
    },
    on_finish: function () {
      $("body").css("cursor", "none"); //鼠标消失
      blockTotalNum_word -= 1;
      $(document.body).unbind();
      clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
    }
  }

 

  let blockTotalNum_same = 3;// 此处填入总block数量-1，比如总数量是3，那么值就需要是2
let rest_same = {
  type:"html-button-response",
  stimulus: function () {
      let totaltrials = jsPsych.data.get().filter(
        [{ correct: true }, { correct: false }]
      );
      return `
                    <p>你当前还剩余${blockTotalNum_same}组实验</p>
                    <p>现在是休息时间，当你结束休息后，你可以点击 结束休息 按钮 继续</p>
                    <p>建议休息时间还剩余<span id="iii">60</span>秒</p>`
    },
    choices: ["结束休息"],
    on_load: function () {
      $("body").css("cursor", "default");
      let tmpTime = setInterval(function () {
        $("#iii").text(parseInt($("#iii").text()) - 1);
        if (parseInt($("#iii").text()) < 1) {
          $("#iii").parent().text("当前限定休息时间已到达，如果还未到达状态，请继续休息");
          clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
        }
      }, 1000);
      sessionStorage.setItem("tmpInter", tmpTime);
    },
    on_finish: function () {
      $("body").css("cursor", "none"); //鼠标消失
      blockTotalNum_same -= 1;
      $(document.body).unbind();
      clearInterval(parseInt(sessionStorage.getItem("tmpInter")));
    }
  }

  let p_gotoword = {
    type: "html-keyboard-response", 
    stimulus: `
    <p>恭喜你，正式实验中的呈现顺序为先图形后文字条件已经完成。</p>
    <p>请你将手指放在按键上，准备进入呈现顺序为<span style='color: yellow;'>先文字后图形条件</span>的正式匹配任务</p>
    <p> <div style = "color: green"><按任意键进入下一阶段的匹配任务></div></p>
    `, 
    choices: jsPsych.ALL_KEYS,
  };


  let p_gotosame = {
    type: "html-keyboard-response", 
    stimulus: `
    <p>恭喜你，正式实验中的呈现顺序为先文字后图片条件已经完成。</p>
    <p>请你将手指放在按键上，准备进入呈现顺序为<span style='color: yellow;'>图形和文字同时呈现条件</span>的正式匹配任务</p>
    <p> <div style = "color: green"><按任意键进入下一阶段的匹配任务></div></p>
    `, 
    choices: jsPsych.ALL_KEYS,
  };

  var repeatblock1 = {
    timeline:[image_first, feedback_block, rest_image],
    repetitions: 4 //4个block
  };
  timeline.push(repeatblock1);
  timeline.push(p_gotoword)

  var repeatblock2 = {
    timeline:[word_first, feedback_block, rest_word],
    repetitions: 4
  };
  timeline.push(repeatblock2);
  timeline.push(p_gotosame)

  var repeatblock3 = {
    timeline:[same, feedback_block, rest_same],
    repetitions: 4
  };
  timeline.push(repeatblock3);

  var finish = {
    type:"html-keyboard-response", 
    stimulus: `
    <p>感谢您参加我们的实验，请<span style="color: yellow;">按任意键开始上传数据</span>，并通知研究者。</p>
    <p>感谢您的配合！</p>`
  };
  timeline.push(finish);




jsPsych.init({
    timeline: timeline,
    on_finish: function() {
    jsPsych.data.get().localSave('csv', info["ID"] + '.csv'); 
    document.exitFullscreen(); // 退出全屏
    let bodyNode = document.getElementsByTagName("body"); // 获取Body窗体
    for (let i = 0; i < bodyNode.length; i++) {
        bodyNode[i].style.cursor = "default";// 显示鼠标
        setTimeout(function () {
            window.close(); // 关闭页面
        }, 15000)
      }
}
});





    </script>
    
</html>